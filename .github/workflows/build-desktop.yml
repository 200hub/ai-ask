name: Build Desktop Platforms

# Reusable workflow for building desktop platforms
# Called by release.yml
#
# Matrix Strategy:
#   - Builds in parallel across multiple OS and architectures
#   - Each platform uploads artifacts separately for independent retrieval
#   - Uses caching (Cargo, pnpm) to speed up repeated builds
#
# Platforms:
#   - Linux x64: DEB, AppImage
#   - Windows x64: MSI, NSIS
#   - Windows ARM64: MSI, NSIS
#   - macOS Intel: DMG, App
#   - macOS Apple Silicon: DMG, App
#
# Performance:
#   - First build: ~10-15 minutes per platform
#   - Cached build: ~5-8 minutes per platform
#   - Parallel execution: All platforms build simultaneously

on:
  workflow_call:
    # Reusable workflow, no outputs required

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    
    strategy:
      fail-fast: false  # Continue building other platforms if one fails
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            arch: x64
            
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            arch: x64
            
          # Windows ARM64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: windows
            arch: arm64
            
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            arch: intel
            
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            arch: arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false
      
      # Get pnpm store directory for caching
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      # Cache pnpm store
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # Setup Rust toolchain
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      # Cache Cargo dependencies
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true
      
      # Install Linux dependencies (only on Ubuntu)
      - name: Install Linux dependencies
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf
          
          # Try to install WebKitGTK in order of preference (newest to oldest)
          # Ubuntu 24.04+ uses libwebkit2gtk-4.1-dev
          # Ubuntu 22.04 uses libwebkit2gtk-4.0-dev
          # Some systems may use libwebkitgtk-6.0-dev
          FOUND_PACKAGE=""
          for package in libwebkit2gtk-4.1-dev libwebkitgtk-6.0-dev libwebkit2gtk-4.0-dev; do
            echo "Attempting to install ${package}..."
            if sudo apt-get install -y "${package}" 2>/dev/null; then
              echo "Successfully installed ${package}"
              FOUND_PACKAGE=1
              break
            fi
          done
          
          if [ -z "${FOUND_PACKAGE}" ]; then
            echo "Error: Failed to install any supported WebKitGTK development package." >&2
            echo "Tried: libwebkit2gtk-4.1-dev, libwebkitgtk-6.0-dev, libwebkit2gtk-4.0-dev" >&2
            exit 1
          fi
      
      # Install frontend dependencies
      - name: Install frontend dependencies
        run: pnpm install
      
      # Derive MSI-friendly version (Windows only)
      # Maps SemVer to numeric-only format (max 65535 per segment):
      #   0.0.1-alpha.4 -> 0.0.1.10004
      #   0.0.1-beta.7  -> 0.0.1.20007
      #   0.0.1-rc.3    -> 0.0.1.30003
      #   0.0.1         -> 0.0.1.50000
      - name: Derive MSI-friendly version (Windows only)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          # Read original SemVer from tauri.conf.json (do not modify files)
          SEMVER=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "Original SemVer: $SEMVER"

          # Map SemVer pre-release to numeric suffix (Windows requirement: max 65535)
          if [[ "$SEMVER" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-alpha\.([0-9]+)$ ]]; then
            BASE="${BASH_REMATCH[1]}"
            NUM="${BASH_REMATCH[2]}"
            MSI_VERSION="${BASE}.$((10000 + NUM))"
            echo "Mapped alpha.${NUM} -> $((10000 + NUM))"
          elif [[ "$SEMVER" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
            BASE="${BASH_REMATCH[1]}"
            NUM="${BASH_REMATCH[2]}"
            MSI_VERSION="${BASE}.$((20000 + NUM))"
            echo "Mapped beta.${NUM} -> $((20000 + NUM))"
          elif [[ "$SEMVER" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-rc\.([0-9]+)$ ]]; then
            BASE="${BASH_REMATCH[1]}"
            NUM="${BASH_REMATCH[2]}"
            MSI_VERSION="${BASE}.$((30000 + NUM))"
            echo "Mapped rc.${NUM} -> $((30000 + NUM))"
          elif [[ "$SEMVER" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            # Stable release
            MSI_VERSION="${SEMVER}.50000"
            echo "Stable release -> 50000"
          else
            # Fallback: strip everything after base version
            BASE=$(echo "$SEMVER" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
            MSI_VERSION="${BASE}.0"
            echo "WARN: Unrecognized format '$SEMVER', fallback to ${MSI_VERSION}"
          fi

          echo "MSI-friendly version: $MSI_VERSION"

          # Export variables for later steps
          echo "SEMVER=$SEMVER" >> $GITHUB_ENV
          echo "MSI_VERSION=$MSI_VERSION" >> $GITHUB_ENV
      
      # Build Tauri application
      - name: Build Tauri application
        env:
          # On Windows this is a numeric-only version; on other OS it's empty
          TAURI_APP_VERSION: ${{ env.MSI_VERSION }}
        run: pnpm tauri build --target ${{ matrix.target }}
      
      # Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          # Keep artifact name showing original SemVer across all platforms
          name: ${{ matrix.platform }}-${{ matrix.arch }}-${{ env.SEMVER }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
          if-no-files-found: warn
          retention-days: 5
