name: Build Desktop Platforms

# Reusable workflow for building desktop platforms
# Called by release.yml
#
# Matrix Strategy:
#   - Builds in parallel across multiple OS and architectures
#   - Each platform uploads artifacts separately for independent retrieval
#   - Uses caching (Cargo, pnpm) to speed up repeated builds
#
# Platforms:
#   - Linux x64: DEB, AppImage
#   - Windows x64: MSI, NSIS
#   - Windows ARM64: MSI, NSIS
#   - macOS Intel: DMG, App
#   - macOS Apple Silicon: DMG, App
#
# Performance:
#   - First build: ~10-15 minutes per platform
#   - Cached build: ~5-8 minutes per platform
#   - Parallel execution: All platforms build simultaneously

on:
  workflow_call:
    # Reusable workflow, no outputs required

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    
    strategy:
      fail-fast: false  # Continue building other platforms if one fails
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            arch: x64
            
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            arch: x64
            
          # Windows ARM64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: windows
            arch: arm64
            
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            arch: intel
            
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            arch: arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false
      
      # Get pnpm store directory for caching
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      # Cache pnpm store
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # Setup Rust toolchain
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      # Cache Cargo dependencies
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true
      
      # Install Linux dependencies (only on Ubuntu)
      - name: Install Linux dependencies
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

          if ! sudo apt-get install -y libwebkit2gtk-4.1-dev; then
            sudo apt-get install -y libwebkit2gtk-4.0-dev
          fi
      
      # Install frontend dependencies
      - name: Install frontend dependencies
        run: pnpm install

      - name: Sanitize Windows bundle version
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          WINDOWS_VERSION=$(node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const pkg = JSON.parse(fs.readFileSync(path.resolve(process.cwd(), 'package.json'), 'utf8'));
          const version = pkg.version;
          const [base, preRelease] = version.split('-', 2);
          const segments = base.split('.').map(Number);
          while (segments.length < 3) {
            segments.push(0);
          }
          const normalizedBase = segments.slice(0, 3).join('.');
          let suffix = 0;
          if (preRelease) {
            const match = preRelease.match(/\d+/);
            if (match) {
              const value = Math.min(parseInt(match[0], 10), 65535);
              suffix = Number.isFinite(value) ? value : 0;
            }
          }
          console.log(`${normalizedBase}.${suffix}`);
          NODE
          )
          echo "WINDOWS_VERSION=$WINDOWS_VERSION" >> $GITHUB_ENV
      
      # Build application
      - name: Build Tauri application (Windows)
        if: ${{ runner.os == 'Windows' }}
        env:
          TAURI_CONFIG__version: ${{ env.WINDOWS_VERSION }}
        run: pnpm tauri build --target ${{ matrix.target }}

      - name: Build Tauri application
        if: ${{ runner.os != 'Windows' }}
        run: pnpm tauri build --target ${{ matrix.target }}
      
      # Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
          if-no-files-found: warn
          retention-days: 5
