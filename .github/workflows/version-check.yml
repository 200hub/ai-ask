name: Version Check and Auto Release

# ç›‘å¬ tauri.conf.json çš„ç‰ˆæœ¬å˜æ›´ï¼Œè‡ªåŠ¨åŒæ­¥ç‰ˆæœ¬å·å¹¶åˆ›å»º tag è§¦å‘ release
#
# å·¥ä½œæµç¨‹ï¼š
#   1. ç›‘å¬ main åˆ†æ”¯çš„ push äº‹ä»¶
#   2. æ£€æŸ¥ src-tauri/tauri.conf.json æ˜¯å¦æœ‰å˜æ›´
#   3. å¦‚æžœç‰ˆæœ¬å·å‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–æ–‡ä»¶
#   4. åˆ›å»ºæ–°çš„ç‰ˆæœ¬ tag
#   5. è§¦å‘ release å·¥ä½œæµ
#
# ç‰ˆæœ¬å·ç®¡ç†ï¼š
#   - å•ä¸€çœŸå®žæ¥æºï¼šsrc-tauri/tauri.conf.json
#   - è‡ªåŠ¨åŒæ­¥ç›®æ ‡ï¼špackage.json, Cargo.toml, constants.ts
#   - Tag æ ¼å¼ï¼šv{version} (ä¾‹å¦‚ï¼šv1.0.0)
#
# æ³¨æ„äº‹é¡¹ï¼š
#   - åªåœ¨ main åˆ†æ”¯è§¦å‘
#   - éœ€è¦é…ç½® PAT_TOKEN secret ä»¥è§¦å‘åŽç»­å·¥ä½œæµï¼ˆå¯é€‰ï¼Œæ—  PAT æ—¶ä½¿ç”¨ GITHUB_TOKENï¼‰
#   - ç‰ˆæœ¬å·å¿…é¡»ç¬¦åˆ semver è§„èŒƒ
#
# Secret é…ç½®ï¼ˆæŽ¨èï¼‰ï¼š
#   PAT_TOKEN: Personal Access Tokenï¼Œéœ€è¦ repo å’Œ workflow æƒé™
#   - å¦‚æžœé…ç½®äº† PAT_TOKENï¼Œtag æŽ¨é€ä¼šè§¦å‘ release.yml
#   - å¦‚æžœæœªé…ç½®ï¼Œå°†ä½¿ç”¨ GITHUB_TOKENï¼ˆä½†ä¸ä¼šè§¦å‘åŽç»­å·¥ä½œæµï¼Œéœ€æ‰‹åŠ¨è§¦å‘ï¼‰

on:
  push:
    branches:
      - main
    paths:
      - 'src-tauri/tauri.conf.json'

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º tag å’Œæäº¤å˜æ›´

jobs:
  check-version:
    name: Check Version and Create Tag
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦è‡³å°‘ä¸¤ä¸ª commit æ¥æ¯”è¾ƒå˜æ›´
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ PAT ä»¥è§¦å‘åŽç»­å·¥ä½œæµ
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æœ‰å˜åŒ–
      - name: Check if version changed
        id: version-check
        run: |
          # èŽ·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # ä½¿ç”¨ git show èŽ·å–ä¸Šä¸€ä¸ª commit çš„ç‰ˆæœ¬ï¼ˆä¸æ”¹å˜å·¥ä½œåŒºï¼‰
          PREVIOUS_VERSION=$(git show HEAD~1:src-tauri/tauri.conf.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null || echo "none")
          
          echo "Previous version: $PREVIOUS_VERSION"
          
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å˜åŒ–
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $CURRENT_VERSION"
          fi
      
      # å®‰è£…ä¾èµ–ï¼ˆä»…åœ¨ç‰ˆæœ¬å˜æ›´æ—¶ï¼‰
      - name: Install dependencies
        if: steps.version-check.outputs.changed == 'true'
        run: |
          # æ£€æŸ¥ lockfile æ˜¯å¦å­˜åœ¨
          if [ -f "pnpm-lock.yaml" ]; then
            echo "Installing with frozen lockfile..."
            pnpm install --frozen-lockfile
          else
            echo "No lockfile found, installing without freeze..."
            pnpm install --no-frozen-lockfile
          fi
      
      # åŒæ­¥ç‰ˆæœ¬å·åˆ°å…¶ä»–æ–‡ä»¶
      - name: Sync version to other files
        if: steps.version-check.outputs.changed == 'true'
        run: |
          echo "Synchronizing version ${{ steps.version-check.outputs.version }} to all files..."
          pnpm run version:sync
      
      # é…ç½® Git
      - name: Configure Git
        if: steps.version-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      # æäº¤ç‰ˆæœ¬åŒæ­¥çš„å˜æ›´
      - name: Commit version sync changes
        if: steps.version-check.outputs.changed == 'true'
        run: |
          git add package.json src-tauri/Cargo.toml src/lib/utils/constants.ts
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: sync version to ${{ steps.version-check.outputs.version }}"
            git push origin main
          fi
      
      # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
      - name: Check if tag exists
        if: steps.version-check.outputs.changed == 'true'
        id: tag-check
        run: |
          TAG_NAME="v${{ steps.version-check.outputs.version }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME does not exist"
          fi
      
      # åˆ›å»ºæ–°çš„ tag
      - name: Create version tag
        if: steps.version-check.outputs.changed == 'true' && steps.tag-check.outputs.exists == 'false'
        run: |
          TAG_NAME="v${{ steps.version-check.outputs.version }}"
          echo "Creating tag $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Tag $TAG_NAME created and pushed"
      
      # è¾“å‡ºç»“æžœ
      - name: Summary
        if: steps.version-check.outputs.changed == 'true'
        run: |
          echo "âœ… Version updated to ${{ steps.version-check.outputs.version }}"
          echo "âœ… All files synchronized"
          echo "âœ… Tag v${{ steps.version-check.outputs.version }} created"
          echo "ðŸš€ Release workflow will be triggered automatically"
